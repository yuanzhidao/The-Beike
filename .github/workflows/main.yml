name: Build iOS Unsigned IPA

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch: # 允许手动点击按钮触发

jobs:
  build-ios:
    name: Build iOS
    runs-on: macos-latest # 使用云端 Mac

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - name: Install dependencies
        run: flutter pub get

      # 1. 构建 iOS Release 版本（不签名）
      - name: Build iOS Release (No Codesign)
        run: |
          flutter build ios --release --no-codesign
          
      # 2. 创建 Payload 文件夹结构 (手动制作 IPA 的关键步骤)
      - name: Create IPA Structure
        run: |
          mkdir -p Payload
          mv build/ios/iphoneos/Runner.app Payload/
          # 压缩 Payload 文件夹为 Lyra.ipa
          zip -r TheBeike.ipa Payload

      # 3. 上传生成的 IPA 供下载
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-ipa
          path: TheBeike.ipa
